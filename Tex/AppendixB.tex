\chapter*{附录B\quad SpareNTM的损失函数推导细节}

在正文中外我们定义了变分分布 $q(\theta,b|x)=q(b|x;\hat{\lambda})q(\theta|x,b;\hat{\alpha})$ 去估计真实的后验分布$p(\theta,b|x)$, 其中 $q(b|x;\hat{\lambda})=\prod_{k=1}^{K}q(b_k|\hat{\lambda}_k)$, $q(b_k|\hat{\lambda}_k)$ 是一个参数为 $\hat{\lambda}_k$的伯努利分布。同时，我们定义了$q(\theta|x,b;\hat{\alpha})=\mbox{Dir}(b\cdot\hat{\alpha})$. 因此, SpareNTM的变分推断将优化以下ELBO：
\begin{align}
	\mathcal{L}(x)&=E_{q(\theta,b|x)}\left[\log p(x,\theta,b|\alpha,\lambda,\beta) - \log q(\theta,b|x)\right]\\
        &=E_{q(\theta,b|x)}\left[\log p(x|\theta)+\log p(\theta|b)+\log p(b)-\log q(b|x)-\log q(\theta|x,b)\right]\nonumber\\
	&=E_{q(\theta,b|x)}\left[\log p(x|\theta)\right]-E_{q(\theta,b|x)}\left[\log\frac{q(\theta|x,b)}{p(\theta|b)}\right]-E_{q(\theta,b|x)}\left[\log\frac{q(b|x)}{p(b)}\right]\nonumber\\
        &=\mathcal{L}_{rec}+\mathcal{L}_\theta+\mathcal{L}_b\nonumber
\end{align}

\section*{B.1\ $\mathcal{L}_\theta$项的推导}
Term $\mathcal{L}_\theta=-E_{q(\theta,b|x)}\left[\log\frac{q(\theta|x,b)}{p(\theta|b)}\right]$ can be written to:

\begin{equation}
\begin{aligned}
&E_{q(\theta,b|x)}\left[\log\frac{q(\theta|x,b)}{p(\theta|b)}\right]=\int_{\theta,b}q(b|x)q(\theta|x,b)\log \frac{q(\theta|x,b)}{p(\theta|b)}\dif\theta,b\\
&=\int_{b}q(b|x)\int_{\theta}q(\theta|x,b)\log \frac{q(\theta|x,b)}{p(\theta|b)}\dif\theta\dif b=E_{q(b|x)}[KL(q(\theta|x,b)||p(\theta|b))]
\end{aligned}
\end{equation}

\section*{B.2\ $\mathcal{L}_b$项的推导}
$\mathcal{L}_b=-E_{q(\theta,b|x)}\left[\log\frac{q(b|x)}{p(b)}\right]$将被改写为:

\begin{equation}
\begin{aligned}
&E_{q(\theta,b|x)}\left[\log\frac{q(b|x)}{p(b)}\right]=\int_{\theta,b}q(b|x)q(\theta|x,b)\log \frac{q(b|x)}{p(b)}\dif\theta,b\\
&=\int_b q(b|x)\log \frac{q(b|x)}{p(b)}\left(\int_\theta q(\theta|x,b)\dif\theta\right)\dif b\\
&=\int_b q(b|x)\log \frac{q(b|x)}{p(b)}\dif b=\int_b \prod_{k=1}^K q(b_k|x)\cdot\log \prod_{k=1}^K\frac{q(b_k|x)}{p(b_k)}\dif b\\
&=\int_{b_2\dots b_K}q(b_2|x)\dots q(b_K|x)\left[\int_{b_1}q(b_1|x)\log \frac{q(b_1|x)}{p(b_1)}+q(b_1|x)\log \frac{q(b_2|x)\dots q(b_K|x)}{p(b_2)\dots q(b_K)}\dif b_1\right]\dif b_2\dots b_K\\
&=KL(q(b_1|x)||p(b_1))+\int_{b_2\dots b_K}q(b_2|x)\dots q(b_K|x)\log \frac{q(b_2|x)\dots q(b_K|x)}{p(b_2)\dots q(b_K)}\dif b_2\dots b_K\\
&=\sum_{k=1}^{K}KL(q(b_k|x)||p(b_k))
\end{aligned}
\end{equation}